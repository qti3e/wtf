<!DOCTYPE html>
<html lang="en">
 <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parsa's Blog | Faster JS Blake3</title>
    <meta name="author" content="Parsa G.">
    <meta name="description" content="My random thoughts on computers">
    <link rel="icon" href="data:image/svg+xml,
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'>
  <text y='0.9em' fill='rgb(200,162,200)' font-size='90'>Î»</text>
</svg>">
    <style>
@keyframes blink{50%{opacity:0}}:root{--color-bg:#000;--color-text:#fefefe;--color-text-muted:#666;--color-link:cyan;--color-link-hover:#00ffff;--color-accent:rgb(200, 162, 200);--color-selection-bg:#fefefe;--color-selection-text:#000;--color-border:#fefefe;--color-code-bg:#1a1a1a;--color-terminal-prompt:#00ff00;--pride-red:#E40303;--pride-orange:#FF8C00;--pride-yellow:#FFED00;--pride-green:#008026;--pride-blue:#004DFF;--pride-purple:#750787;--font-mono:Menlo, Monaco, Consolas, "Andale Mono", "Ubuntu Mono", "Courier New", monospace;--font-size-base:24px;--font-size-code:20px;--font-size-prism:13px;--line-height:1.7;--content-max-width:120ch;--content-padding:3ch;--header-padding:8ch;--sidebar-width:36px;--transition-fast:150ms ease}*,.header ul{padding:0;margin:0}*{box-sizing:border-box;font-size:var(--font-size-base);font-family:monospace}html{height:100%;scroll-behavior:smooth}body{min-height:100%;text-align:justify;overflow-wrap:break-word;background:var(--color-bg)!important;padding-left:var(--sidebar-width)}.container,.page{min-height:100vh;display:flex}.page{justify-content:center}.container{flex-direction:column;color:var(--color-text);width:100%;max-width:var(--content-max-width);border-left:1px solid var(--color-border);border-right:1px solid var(--color-border)}.header{flex:0 0 auto;border-bottom:1px solid var(--color-border);display:flex;justify-content:space-between;align-items:center;height:2lh;padding:0 var(--header-padding)}.header ul{list-style:none;display:flex;gap:.5rem}.header svg{width:1lh;height:1lh;display:block;transition:transform var(--transition-fast)}.header a:focus svg,.header a:hover svg{transform:scale(1.1)}.footer{flex:0 0 auto;border-top:1px solid var(--color-border);height:2lh;display:flex;justify-content:space-between;align-items:center;padding:0 4ch}.side{--progress:100%;position:fixed;top:0;left:0;width:var(--sidebar-width);height:max(2lh,var(--progress));z-index:100;background:linear-gradient(to right,var(--pride-red) 0% 16.666%,var(--pride-orange) 16.666% 33.333%,var(--pride-yellow) 33.333% 50%,var(--pride-green) 50% 66.666%,var(--pride-blue) 66.666% 83.333%,var(--pride-purple) 83.333% 100%)}.side .bar,.toc{display:none}.toc{position:sticky;top:3lh;align-self:flex-start;width:24ch;flex-shrink:0;max-height:calc(100vh - 6lh);overflow-y:auto;padding:1ch}.toc ul{list-style:none;padding:0;margin:0}.toc-item{padding-left:calc(var(--indent, 0)*1.5ch);margin:.3em 0;position:relative}.toc-item a,.toc-item::before{font-size:11px;color:var(--color-text-muted)}.toc-item::before{content:"â”€";position:absolute;left:calc(var(--indent, 0)*1.5ch - 1.5ch);opacity:.5}.toc-level-1::before{content:none}.toc-item a{display:block;line-height:1.4;text-decoration:none;transition:color var(--transition-fast);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.toc-item a.active,.toc-item a:hover{color:var(--color-text)}@media (min-width:1400px){.toc{display:block}}.content{flex:1 1 auto;padding:var(--content-padding);font-size:var(--font-size-base);line-height:var(--line-height)}.content p{margin:1lh 0}::-webkit-scrollbar{width:8px}::-webkit-scrollbar-track{background:var(--color-bg)}::-webkit-scrollbar-thumb{background:var(--color-text-muted);border-radius:4px}::-webkit-scrollbar-thumb:hover{background:var(--color-text)}.content h1,.content h2,.content h3,.content h4{margin:1lh 0;line-height:1.2;position:relative;font-weight:700}.content .anchor{margin-right:4ch;position:absolute;left:-2ch;top:50%;transform:translateY(-50%);opacity:0;transition:opacity var(--transition-fast)}.content h1:hover .anchor,.content h2:hover .anchor,.content h3:hover .anchor,.content h4:hover .anchor{opacity:1}.content h1{font-size:32px;padding-left:1ch}.content h2{font-size:28px;padding-left:2ch}.content h3{font-size:24px;padding-left:3ch}.content h4{font-size:20px;padding-left:4ch}.content h1::before,.content h2::before,.content h3::before,.content h4::before{position:absolute;left:0;top:50%;transform:translateY(-50%);font-size:.8em;color:var(--color-text-muted)}.content h1::before{content:"#"}.content h2::before{content:"##"}.content h3::before{content:"###"}.content h4::before{content:"####"}.content blockquote{border-left:2px solid var(--color-accent);padding-left:1ch;margin-left:1ch;color:var(--color-text);font-style:italic}.octicon{fill:var(--color-text)}.content a{color:var(--color-link);text-decoration:none;transition:color var(--transition-fast),text-decoration var(--transition-fast)}.content a:focus,.content a:hover{color:var(--color-link-hover);text-decoration:underline}.content a:focus-visible{outline:2px solid var(--color-link);outline-offset:2px}.header h1{position:relative;padding-left:3ch}.header h1::after{content:"Î»";position:absolute;left:1.2ch;top:0;color:var(--color-accent)}.header h1 a{color:inherit;text-decoration:none}.clip-copy{user-select:all}.footer .clip-copy::before{content:"> ";color:var(--color-terminal-prompt)}.footer:hover .clip-copy::before{animation:blink 1s step-end infinite}::selection{background:var(--color-selection-bg);color:var(--color-selection-text)}::-moz-selection{background:var(--color-selection-bg);color:var(--color-selection-text)}pre{overflow:auto}.content ol,.content ul{padding-left:4ch}.content li{margin:.3lh 0}hr{margin:2lh 8ch;border-color:var(--color-text-muted)}.content table{width:100%;padding:4ch 1lh;border-collapse:collapse}.content td,.content th{padding:.5ch 1ch;border:1px solid var(--color-text-muted);text-align:left}.content th,.highlight{background:var(--color-code-bg)}.content img,.content video{display:block;max-width:100%;margin:1lh auto}.content img{position:relative;min-height:120px;padding:0;background:linear-gradient(90deg,var(--color-text-muted) 1px,transparent 1px),linear-gradient(var(--color-text-muted) 1px,transparent 1px),var(--color-code-bg);background-size:20px 20px;background-position:center}.content img::after{content:"[missing: "attr(alt)"]";display:flex;align-items:center;justify-content:center;position:absolute;inset:0;padding:1ch;color:var(--color-text-muted);font-size:var(--font-size-small);text-align:center}pre code *{font-size:var(--font-size-code)}.content pre{padding:1ch}.highlight{margin:1ch;border:solid 1px var(--color-border);border-radius:4px}.content code:not([class*=language-]){background:var(--color-code-bg);padding:.1em .4em;border-radius:3px;font-size:.9em;color:#e06c75}@media (max-width:600px){:root{--font-size-base:18px;--content-padding:1ch;--header-padding:1ch;--sidebar-width:0}body{line-height:1.6;padding-left:0;padding-top:18px}.side{position:fixed;top:0;left:0;width:max(10%,var(--progress));height:18px;background:linear-gradient(to bottom,var(--pride-red) 0% 16.666%,var(--pride-orange) 16.666% 33.333%,var(--pride-yellow) 33.333% 50%,var(--pride-green) 50% 66.666%,var(--pride-blue) 66.666% 83.333%,var(--pride-purple) 83.333% 100%)}.toc{display:none!important}.container,.header{border:0}.header{padding:0 1ch}.header h1{font-size:1.2rem}.header ul{gap:.2rem}.header svg{width:.8lh;height:.8lh}.content{padding:1ch;font-size:18px;-webkit-overflow-scrolling:touch}.content h1,.content h2,.content h3,.content h4{margin:.5lh 0}.content h1{font-size:24px;padding-left:1ch}.content h2{font-size:20px;padding-left:2ch}.content h3{font-size:18px;padding-left:3ch}.content h4{font-size:16px;padding-left:4ch}.footer{padding:0 1ch}.footer .clip-copy{display:none}}code[class*=language-],pre[class*=language-]{color:#d4d4d4;font-size:13px;text-shadow:none;font-family:Menlo,Monaco,Consolas,"Andale Mono","Ubuntu Mono","Courier New",monospace;direction:ltr;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{text-shadow:none;background:#264f78}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto;background:#1e1e1e}:not(pre)>code[class*=language-]{padding:.1em .3em;border-radius:.3em;color:#db4c69;background:#1e1e1e}.namespace{opacity:.7}.token.doctype .token.doctype-tag,.token.operator.arrow{color:#569cd6}.token.doctype .token.name{color:#9cdcfe}.token.comment,.token.prolog{color:#6a9955}.language-html .language-css .token.punctuation,.language-html .language-javascript .token.punctuation,.token.punctuation{color:#d4d4d4}.token.inserted,.token.number,.token.symbol,.token.unit{color:#b5cea8}.token.builtin,.token.char,.token.deleted,.token.string{color:#ce9178}.language-css .token.string.url{text-decoration:underline}.token.operator{color:#d4d4d4}.token.atrule{color:#ce9178}.token.atrule .token.rule,.token.keyword.control-flow,.token.keyword.module{color:#c586c0}.token.atrule .token.url{color:#9cdcfe}.token.atrule .token.url .token.function{color:#dcdcaa}.token.atrule .token.url .token.punctuation,.token.attr-value .token.punctuation.attr-equals{color:#d4d4d4}.token.keyword{color:#569cd6}.token.function,.token.function .token.maybe-class-name{color:#dcdcaa}.token.regex{color:#d16969}.token.important,.token.punctuation.interpolation-punctuation{color:#569cd6}.token.italic{font-style:italic}.token.constant{color:#9cdcfe}.token.class-name,.token.maybe-class-name{color:#4ec9b0}.token.console,.token.interpolation,.token.parameter{color:#9cdcfe}.token.boolean{color:#569cd6}.token.exports .token.maybe-class-name,.token.imports .token.maybe-class-name,.token.property,.token.variable{color:#9cdcfe}.token.escape,.token.selector{color:#d7ba7d}.token.tag{color:#569cd6}.token.cdata,.token.tag .token.punctuation{color:gray}.token.attr-name,code[class*=language-javascript],code[class*=language-jsx],code[class*=language-tsx],code[class*=language-typescript],pre[class*=language-javascript],pre[class*=language-jsx],pre[class*=language-tsx],pre[class*=language-typescript]{color:#9cdcfe}.token.attr-value,.token.attr-value .token.punctuation,code[class*=language-css],pre[class*=language-css]{color:#ce9178}.token.entity{color:#569cd6}.token.namespace{color:#4ec9b0}code[class*=language-html],pre[class*=language-html]{color:#d4d4d4}.language-regex .token.anchor{color:#dcdcaa}.language-html .token.punctuation{color:gray}pre[class*=language-]>code[class*=language-]{position:relative;z-index:1}.line-highlight.line-highlight{background:#f7ebc6;box-shadow:inset 5px 0 0#f7d87c;z-index:0}@media print{:root{--color-bg:#fff;--color-text:#000;--color-border:#ccc}body{background:#fff!important;color:#000}.footer,.header,.side{display:none}.container{height:auto}.body{display:block}.content{max-width:100%;border:0;overflow:visible;padding:0;font-size:12pt}.content a{color:#000;text-decoration:underline}.content a[href]::after{content:" ("attr(href)")";font-size:.8em;color:#666}.highlight,pre[class*=language-]{border:1px solid #ccc;background:#f5f5f5}}
    </style>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
      const headings = [...document.querySelectorAll('.content h1[id], .content h2[id], .content h3[id], .content h4[id]')];
      const links = document.querySelectorAll('.toc a');
      const side = document.querySelector('.side');
      const update = () => {
        const vh = window.innerHeight;
        // ToC active state
        if (headings.length && links.length) {
          let active = null, lastPassed = null;
          for (const h of headings) {
            const top = h.getBoundingClientRect().top;
            if (top <= 0) lastPassed = h;
            if (top >= 0 && top < vh) active = h;
          }
          active = active || lastPassed || headings[0];
          links.forEach(l => l.classList.toggle('active', l.getAttribute('href') === '#' + active.id));
        }
        // Progress bar
        if (side) {
          const scrollTop = window.scrollY;
          const docHeight = document.documentElement.scrollHeight - vh;
          const pct = docHeight > 1 ? Math.min(100, Math.max(0, scrollTop / docHeight * 100)) : 100;
          side.style.setProperty('--progress', pct + '%');
        }
      };
      document.addEventListener('scroll', update, { passive: true });
      update();
    });
    </script>
  </head>
  <body>
    <div class="side">
      <div class="bar"></div><div class="bar"></div><div class="bar"></div>
      <div class="bar"></div><div class="bar"></div><div class="bar"></div>
    </div>
    <div class="page">
      <nav class="toc"><ul><li class="toc-item toc-level-1" style="--indent: 0"><a href="#blake3-a-javascript-optimization-case-study">Blake3: A JavaScript Optimization Case Study</a></li><li class="toc-item toc-level-2" style="--indent: 1"><a href="#the-problem-with-wasm">The Problem With WASM</a></li><li class="toc-item toc-level-2" style="--indent: 1"><a href="#setting-up-the-benchmark">Setting Up The Benchmark</a></li><li class="toc-item toc-level-2" style="--indent: 1"><a href="#my-first-pure-js-implementation">My First Pure JS Implementation</a></li><li class="toc-item toc-level-2" style="--indent: 1"><a href="#setting-up-the-test-ground">Setting Up The Test Ground</a></li><li class="toc-item toc-level-2" style="--indent: 1"><a href="#first-look-at-the-javascript-performance">First Look At The JavaScript Performance</a></li><li class="toc-item toc-level-2" style="--indent: 1"><a href="#step-1-using-a-profiler">Step 1: Using a Profiler</a></li><li class="toc-item toc-level-2" style="--indent: 1"><a href="#step-2-precomputing-permute">Step 2: Precomputing Permute</a></li><li class="toc-item toc-level-2" style="--indent: 1"><a href="#step-3-inlining-round-into-compress">Step 3: Inlining Round Into Compress</a></li><li class="toc-item toc-level-2" style="--indent: 1"><a href="#step-4-avoid-repeated-reads-and-writes-from-the-typedarray">Step 4: Avoid Repeated Reads and Writes From the TypedArray</a></li><li class="toc-item toc-level-2" style="--indent: 1"><a href="#step-5-avoid-copies">Step 5: Avoid Copies</a></li><li class="toc-item toc-level-2" style="--indent: 1"><a href="#step-6-using-variables-for-blockwords">Step 6: Using Variables for blockWords</a></li><li class="toc-item toc-level-2" style="--indent: 1"><a href="#step-7-reuse-internal-buffers">Step 7: Reuse Internal Buffers</a></li><li class="toc-item toc-level-2" style="--indent: 1"><a href="#step-8-blake3-is-little-endian-friendly">Step 8: Blake3 Is Little Endian Friendly</a></li><li class="toc-item toc-level-2" style="--indent: 1"><a href="#giving-wasm-simd-a-chance">Giving WASM SIMD a Chance</a></li><li class="toc-item toc-level-3" style="--indent: 2"><a href="#wasm-binary-format">WASM Binary Format</a></li><li class="toc-item toc-level-3" style="--indent: 2"><a href="#what-is-simd">What is SIMD?</a></li><li class="toc-item toc-level-3" style="--indent: 2"><a href="#memory-layout">Memory Layout</a></li><li class="toc-item toc-level-3" style="--indent: 2"><a href="#some-webassembly-instructions">Some WebAssembly Instructions</a></li><li class="toc-item toc-level-3" style="--indent: 2"><a href="#generating-the-code">Generating the Code</a></li><li class="toc-item toc-level-2" style="--indent: 1"><a href="#step-9-simple-use-of-compress4x">Step 9: Simple use of compress4x</a></li><li class="toc-item toc-level-2" style="--indent: 1"><a href="#future-work">Future Work</a></li></ul></nav>
      <div class="container">
      <header class="header">
        <h1><a href="/">Parsa's Blog</a></h1>
        <ul>
          <li>
            <a target="_blank" href="https://github.com/qti3e">
              <svg viewBox="0 0 96 96" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" clip-rule="evenodd" d="M48.854 0C21.839 0 0 22 0 49.217c0 21.756 13.993 40.172 33.405 46.69 2.427.49 3.316-1.059 3.316-2.362 0-1.141-.08-5.052-.08-9.127-13.59 2.934-16.42-5.867-16.42-5.867-2.184-5.704-5.42-7.17-5.42-7.17-4.448-3.015.324-3.015.324-3.015 4.934.326 7.523 5.052 7.523 5.052 4.367 7.496 11.404 5.378 14.235 4.074.404-3.178 1.699-5.378 3.074-6.6-10.839-1.141-22.243-5.378-22.243-24.283 0-5.378 1.94-9.778 5.014-13.2-.485-1.222-2.184-6.275.486-13.038 0 0 4.125-1.304 13.426 5.052a46.97 46.97 0 0 1 12.214-1.63c4.125 0 8.33.571 12.213 1.63 9.302-6.356 13.427-5.052 13.427-5.052 2.67 6.763.97 11.816.485 13.038 3.155 3.422 5.015 7.822 5.015 13.2 0 18.905-11.404 23.06-22.324 24.283 1.78 1.548 3.316 4.481 3.316 9.126 0 6.6-.08 11.897-.08 13.526 0 1.304.89 2.853 3.316 2.364 19.412-6.52 33.405-24.935 33.405-46.691C97.707 22 75.788 0 48.854 0z" fill="#fff"/></svg>
            </a>
          </li>
        </ul>
      </header>
      <main class="content">
      <blockquote>
<p>This is a rewrite/repost of an <a href="http://web.archive.org/web/20240523200557/https://blog.fleek.network/post/fleek-network-blake3-case-study/" rel="noopener noreferrer">older blog post of mine</a>.
The code is available on <a href="https://github.com/qti3e/blake3-js" rel="noopener noreferrer">GitHub</a>.</p>
</blockquote>
<p><strong>TL;DR:</strong> Started with a WASM Blake3 that I wanted to improve. Wrote a naive JS port (~2000x slower), then optimized it step by stepâ€”profiling, inlining, avoiding allocations, using local variables instead of arrays, and exploiting little-endian. Pure JS ended up 1.6x faster than WASM. Then I generated SIMD WASM at runtime (no <code>.wasm</code> file shipped) for a final result of <strong>2.21x faster</strong> than the original.</p>
<hr />
<h1 id="blake3-a-javascript-optimization-case-study"><a class="anchor" aria-hidden="true" tabindex="-1" href="#blake3-a-javascript-optimization-case-study"><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Blake3: A JavaScript Optimization Case Study</h1>
<p>Blake3 is a popular hashing algorithm that performs a few times faster than others like SHA-256. A couple of months ago I needed to use it in a browser and was a bit disappointed with the throughput and the size of the WASM module, so here's how I made it faster.</p>
<p>It achieves this by:</p>
<ol>
<li>Using fewer rounds in its compression function (see <a href="https://eprint.iacr.org/2019/1492" rel="noopener noreferrer"><em>Too Much Crypto</em></a> for the rationale), and</li>
<li>Enabling high parallelization where each chunk of data can be processed in parallel before the merge, through the Merkle Tree-style splitting of the data and merging of the two nodes to form parents.</li>
</ol>
<p><video src="/static/blake3/blake3-hashing.mp4" controls loop muted playsinline></video></p>
<p>This article will focus on the technical details of how I made Blake3 run faster in browsers.</p>
<p>However, since Blake3 is not part of the SubtleCrypto API, native implementations of the algorithm are not provided in the browser. This leaves developers to have to use other implementations. However, currently, there is only a WASM implementation.</p>
<p>Yet the WASM implementation does not use SIMD which seems to be wasted potential, so in this blog, I want to explore the performance of a pure JavaScript implementation of the algorithm and then do some black magic to use SIMD.</p>
<h2 id="the-problem-with-wasm"><a class="anchor" aria-hidden="true" tabindex="-1" href="#the-problem-with-wasm"><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>The Problem With WASM</h2>
<p><strong>High shipping cost.</strong> This comes in two forms. First of all, WASM files are relatively large for what they do. The simple Blake3 implementation produces a 17KB binary file that can not be compressed any further, while a JS file could be. Gzipping a WASM file does not have any effect for obvious reasons.</p>
<p>The second issueâ€”and this is more from a tooling aspectâ€”is that the maintenance cost of a JS library that uses WASM could be a bit harder than it should be. You have to consider different runtimes and how you want to get the WASM file. And personally as a developer, I'd rather not depend on a process that involves loading a WASM file.</p>
<p>JavaScript is simple: you can ship one file and it will just work. You don't even have to care about much. And of course, these points I'm making are coming from a point of preference.</p>
<p>However, eventually in this blog I will use WebAssembly, but at no point do I intend to ship a <code>.wasm</code> file. So let's go.</p>
<h2 id="setting-up-the-benchmark"><a class="anchor" aria-hidden="true" tabindex="-1" href="#setting-up-the-benchmark"><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Setting Up The Benchmark</h2>
<p>We can't improve what we can't measure, and yet there are different JS runtimes around. To keep the data simpler to understand, I primarily focus on the JS performance on V8. Maybe in the future I can go through the same process in some other engines and that could be an interesting article of its own.</p>
<p>The benchmark is simple: I generate some 1MB random data and use <code>Deno.bench</code> to compare the performance of the different hash functions on some standard data sizes. I'm going to run these on an Apple M1 Max and compare the results.</p>
<p>To get started I can set a baseline by comparing an implementation of SHA-256 and a WASM compilation of the hash function from the official Rust implementation.</p>
<div class="highlight highlight-source-typescript notranslate"><pre><span class="token keyword">import</span> <span class="token punctuation">{</span> hash <span class="token keyword">as</span> rustWasmHash <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./blake3-wasm/pkg/blake3_wasm.js"</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> sha256 <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"https://denopkg.com/chiefbiiko/sha256@v1.0.0/mod.ts"</span><span class="token punctuation">;</span>

<span class="token comment">// Share the same input buffer across benchmarks.</span>
<span class="token keyword">const</span> <span class="token">INPUT_BUFFER</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token">BENCH_CASES</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token">string</span><span class="token punctuation">,</span> <span class="token">number</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">[</span>
  <span class="token punctuation">[</span><span class="token string">"96B"</span><span class="token punctuation">,</span> <span class="token number">96</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">"512B"</span><span class="token punctuation">,</span> <span class="token number">512</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">"1Kib"</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">"32Kib"</span><span class="token punctuation">,</span> <span class="token number">32</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">"64Kib"</span><span class="token punctuation">,</span> <span class="token number">64</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">"256Kib"</span><span class="token punctuation">,</span> <span class="token number">256</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">[</span><span class="token string">"1MB"</span><span class="token punctuation">,</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">[</span>humanSize<span class="token punctuation">,</span> length<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Slice up to `length` many bytes from the shared array.</span>
  <span class="token keyword">const</span> array <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token">INPUT_BUFFER</span><span class="token punctuation">.</span>buffer<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token operator">&lt;</span><span class="token punctuation">[</span><span class="token">string</span><span class="token punctuation">,</span> Uint8Array<span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token punctuation">[</span>humanSize<span class="token punctuation">,</span> array<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Randomize the input.</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token">INPUT_BUFFER</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> rng <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> Number<span class="token punctuation">.</span><span class="token">MAX_SAFE_INTEGER</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token">INPUT_BUFFER</span><span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> rng <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">;</span>
    rng <span class="token operator">&gt;&gt;=</span> <span class="token number">8</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">bench</span><span class="token punctuation">(</span>name<span class="token operator">:</span> <span class="token">string</span><span class="token punctuation">,</span> <span class="token function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span>array<span class="token operator">:</span> Uint8Array<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>group<span class="token punctuation">,</span> input<span class="token punctuation">]</span> <span class="token keyword">of</span> <span class="token">BENCH_CASES</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Deno<span class="token punctuation">.</span><span class="token function">bench</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      name<span class="token operator">:</span> <span class="token"><span class="token string">`</span><span class="token"><span class="token punctuation">${</span>name<span class="token punctuation">}</span></span><span class="token string"> </span><span class="token"><span class="token punctuation">${</span>group<span class="token punctuation">}</span></span><span class="token string">`</span></span><span class="token punctuation">,</span>
      group<span class="token punctuation">,</span>
      <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">fn</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token function">bench</span><span class="token punctuation">(</span><span class="token string">"Sha256"</span><span class="token punctuation">,</span> sha256<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">bench</span><span class="token punctuation">(</span><span class="token string">"Rust (wasm)"</span><span class="token punctuation">,</span> rustWasmHash<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div><blockquote>
<p>ðŸ“Œ You can also see this initial state of the repo at this point of the journey on the GitHub link. As I make progress in the blog there will be new commits on that repo. So in case you want to jump ahead and just look at the outcome, you can just go to the main branch on that repo and check it out!</p>
</blockquote>
<p><img src="/static/blake3/graph1.png" alt="Baseline Benchmark" /></p>
<h2 id="my-first-pure-js-implementation"><a class="anchor" aria-hidden="true" tabindex="-1" href="#my-first-pure-js-implementation"><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>My First Pure JS Implementation</h2>
<p>For the first implementation, I can skip over any creativity. My goal is to be more concerned with the correctness of the algorithm so I mainly base the initial implementation on the <code>reference_impl.rs</code> file from the official Blake3 repository. The only adjustment is that I only care about implementing a hash function and not an incremental hasher.</p>
<p>As my main entry point, I have the hash function defined as:</p>
<div class="highlight highlight-source-typescript notranslate"><pre><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">hash</span><span class="token punctuation">(</span>input<span class="token operator">:</span> Uint8Array<span class="token punctuation">)</span><span class="token operator">:</span> Uint8Array <span class="token punctuation">{</span><span class="token operator">...</span><span class="token punctuation">}</span></pre></div><p>In this function, I mainly split the input into full chunks (that is 1024 bytes), and run the compression function on each 16 blocks that make up the chunk. (So each block is 64 bytes.)</p>
<p>At the end of compressing each chunk of data I push it to the chaining value stack, and after thatâ€”depending on where I am in the inputâ€”I merge a few items on the stack to form the parents. This is done by counting the number of 0s at the end of the chunk counter (number of trailing zeros) when written in binary. And in case you're wondering why that would work, I want you to notice how that number is the same as the number of parents you can walk up the tree while still being the right child repeatedly.</p>
<p>The rest of the code is mostly the implementation of the compress function that has one job:</p>
<ul>
<li>Take one block of input (64 bytes or 16 words) and 8 words called <code>cv</code>, and compress it down to 8 new words. These 8 words are also called the chaining value.</li>
<li>To hash each chunk of data (1024 bytes, 16 blocks) I repeatedly call the compress function with each block and the previous <code>cv</code>. However, for the first block in each chunk since there's no previous chaining value, I default the first one to <code>IV</code> which stands for Initialization Vector.</li>
</ul>
<blockquote>
<p>ðŸ¤“ <strong>Fun Fact:</strong> Blake3 uses the same IV values as SHA-256â€”the first 32 bits of the fractional parts of the square roots of the first 8 primes 2..19. It also uses the round function from ChaCha, which itself is based on Salsa.</p>
</blockquote>
<h2 id="setting-up-the-test-ground"><a class="anchor" aria-hidden="true" tabindex="-1" href="#setting-up-the-test-ground"><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Setting Up The Test Ground</h2>
<p>To make sure I'm doing things correctly, I use a rather large test vector that is generated using the Rust official implementation and test my JS implementation against it. This way on each iteration and change I make I can make sure I'm still correct before getting hyped about performance. A no-op hash function is always the fastest hash function, but I don't want that, do I?</p>
<h2 id="first-look-at-the-javascript-performance"><a class="anchor" aria-hidden="true" tabindex="-1" href="#first-look-at-the-javascript-performance"><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>First Look At The JavaScript Performance</h2>
<p>At this point, my first JavaScript port is about <strong>~2000x slower</strong> than WebAssembly. Yet looking at the code it is expectedâ€”after all, the first iteration is about keeping it as close as possible to an academic reference implementation. And that comes with a cost.</p>
<hr />
<h2 id="step-1-using-a-profiler"><a class="anchor" aria-hidden="true" tabindex="-1" href="#step-1-using-a-profiler"><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Step 1: Using a Profiler</h2>
<p><strong>See this commit on GitHub:</strong> <a href="https://github.com/qti3e/blake3-js/commit/bbb41a158dae1efe6e5e3d66b9b986d9128203e7" rel="noopener noreferrer"><code>add readLittleEndianWordsFull</code></a></p>
<p>Although the initial code is really bad, it is not surprising and I can clearly see way too many improvements I could make. But to set a better baseline it's better if my first improvement is something that can benefit me the most with the least amount of change to the code.</p>
<p>We can always use a profiler to do this. V8 is shipped with a really nice built-in profiler that is accessible through both Deno and Node.js. However, at the point of writing this blog, only Node comes with the pre-processing tool that takes a V8 log and turns it into a more consumable JSON format.</p>
<p>First, we need a simple JS file that could use the hash function we want to profile:</p>
<div class="highlight highlight-source-typescript notranslate"><pre><span class="token comment">// prof.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> hash <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"../js/v0.ts"</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token">INPUT_BUFFER</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token number">256</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token">INPUT_BUFFER</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> rng <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> Number<span class="token punctuation">.</span><span class="token">MAX_SAFE_INTEGER</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>j<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token">INPUT_BUFFER</span><span class="token punctuation">[</span>i<span class="token operator">++</span><span class="token punctuation">]</span> <span class="token operator">=</span> rng <span class="token operator">&amp;</span> <span class="token number">0xff</span><span class="token punctuation">;</span>
    rng <span class="token operator">&gt;&gt;=</span> <span class="token number">8</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">hash</span><span class="token punctuation">(</span><span class="token">INPUT_BUFFER</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre></div><p>We can run the following commands to get the profiling result:</p>
<div class="highlight highlight-source-bash notranslate"><pre>deno bundle prof.ts <span class="token operator">&gt;</span> prof.js
<span class="token function">node</span> <span class="token">--prof</span> --prof-sampling-interval<span class="token operator">=</span><span class="token number">10</span> prof.js
<span class="token function">node</span> --prof-process <span class="token">--preprocess</span> *-v8.log <span class="token operator">&gt;</span> prof.json</pre></div><p>Looking at the result of the profiler we can see that <code>readLittleEndianWords</code> is one of the hottest functions in the code. So let's improve that as our first step.</p>
<p>Looking at the source of <code>readLittleEndianWords</code> we can see that there are a few conditionals that could have been left out if we knew that we are reading a full block of data. And interestingly enough at every part of the code, we always know that we are reading a full block except for the very last block of data. So let's implement a new variant of the function that leverages that assumption:</p>
<div class="highlight highlight-source-typescript notranslate"><pre><span class="token keyword">function</span> <span class="token function">readLittleEndianWordsFull</span><span class="token punctuation">(</span>
  array<span class="token operator">:</span> ArrayLike<span class="token operator">&lt;</span><span class="token">number</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
  offset<span class="token operator">:</span> <span class="token">number</span><span class="token punctuation">,</span>
  words<span class="token operator">:</span> Uint32Array<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> words<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">,</span> offset <span class="token operator">+=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    words<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span>
      array<span class="token punctuation">[</span>offset<span class="token punctuation">]</span> <span class="token operator">|</span>
      <span class="token punctuation">(</span>array<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span>
      <span class="token punctuation">(</span>array<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">|</span>
      <span class="token punctuation">(</span>array<span class="token punctuation">[</span>offset <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&lt;&lt;</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></pre></div><p>This function is a lot more straightforward and should be relatively easier for a good compiler to optimize.</p>
<p><img src="/static/blake3/graph2.png" alt="Benchmark after Step 1" /></p>
<p>For how small of a change I made, this is definitely a great win. But I'm still far away from the WebAssembly performance.</p>
<hr />
<h2 id="step-2-precomputing-permute"><a class="anchor" aria-hidden="true" tabindex="-1" href="#step-2-precomputing-permute"><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Step 2: Precomputing Permute</h2>
<p><strong>See this commit on GitHub:</strong> <a href="https://github.com/qti3e/blake3-js/commit/ca82907bc1ebb4070db6206f0cf8fe3fe9f0ac34" rel="noopener noreferrer"><code>Inline Permutations</code></a></p>
<p>For this step, I want to draw your attention to these particular lines of the code:</p>
<div class="highlight highlight-source-typescript notranslate"><pre><span class="token keyword">const</span> <span class="token">MSG_PERMUTATION</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
<span class="token keyword">function</span> <span class="token function">round</span><span class="token punctuation">(</span>state<span class="token operator">:</span> <span class="token">W16</span><span class="token punctuation">,</span> m<span class="token operator">:</span> <span class="token">W16</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Mix the columns.</span>
  <span class="token function">g</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">g</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">permute</span><span class="token punctuation">(</span>m<span class="token operator">:</span> <span class="token">W16</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> copy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    m<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> copy<span class="token punctuation">[</span><span class="token">MSG_PERMUTATION</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">compress</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token">W16</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">const</span> block <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span>block_words<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token">W16</span><span class="token punctuation">;</span>
  <span class="token function">round</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> block<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// round 1</span>
  <span class="token function">permute</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">round</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> block<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// round 2</span>
  <span class="token function">permute</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">round</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> block<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// round 3</span>
  <span class="token function">permute</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">round</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> block<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// round 4</span>
  <span class="token function">permute</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">round</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> block<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// round 5</span>
  <span class="token function">permute</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">round</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> block<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// round 6</span>
  <span class="token function">permute</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">round</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> block<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// round 7</span>
  <span class="token function">permute</span><span class="token punctuation">(</span>block<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></pre></div><p>Looking at the code above we can see some annoying things. On the top of the list are the two <code>new Uint32Array</code> calls we have, which are unnecessary allocations and moves of bytes that could be avoided. The other thing that we can notice is that all 6 permute calls are deterministic, and this opens the possibility of pre-computing a look-up table.</p>
<p>In order to inline permute we could change <code>round</code> so we could tell it about an access order it should use rather than actually moving the bytes:</p>
<div class="highlight highlight-source-typescript notranslate"><pre><span class="token keyword">function</span> <span class="token function">round</span><span class="token punctuation">(</span>state<span class="token operator">:</span> <span class="token">W16</span><span class="token punctuation">,</span> m<span class="token operator">:</span> <span class="token">W16</span><span class="token punctuation">,</span> p<span class="token operator">:</span> <span class="token">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Mix the columns.</span>
  <span class="token function">g</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span>p<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span>p<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">g</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span>p<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span> m<span class="token punctuation">[</span>p<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></pre></div><p>Let's write code that generates this for us:</p>
<div class="highlight highlight-source-javascript notranslate"><pre><span class="token keyword">const</span> <span class="token">MSG_PERMUTATION</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 0, ..., 15</span>
<span class="token keyword">let</span> numbers <span class="token operator">=</span> <span class="token">MSG_PERMUTATION</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token">_<span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> idx<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">7</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token"><span class="token string">`</span><span class="token string">round(state, m, [</span><span class="token"><span class="token punctuation">${</span>numbers<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">]);</span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  numbers <span class="token operator">=</span> <span class="token">MSG_PERMUTATION</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token">p</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> numbers<span class="token punctuation">[</span>p<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre></div><p>Running the code above produces:</p>
<div class="highlight highlight-source-typescript notranslate"><pre><span class="token function">round</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> m<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">round</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> m<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">round</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> m<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">round</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> m<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">round</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> m<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">round</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> m<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">round</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> m<span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div><p>Using the above-generated code inside compress we get another <strong>1.6x improvement</strong>â€”it's not as huge a boost as we had, but it's in the right direction.</p>
<p><img src="/static/blake3/graph3.png" alt="Benchmark after Step 2" /></p>
<hr />
<h2 id="step-3-inlining-round-into-compress"><a class="anchor" aria-hidden="true" tabindex="-1" href="#step-3-inlining-round-into-compress"><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Step 3: Inlining Round Into Compress</h2>
<p><strong>See this commit on GitHub:</strong> <a href="https://github.com/qti3e/blake3-js/commit/22eda65bf3ed5f571b8d4d7dd98af3c75d68569b" rel="noopener noreferrer"><code>Inline Round into Compress</code></a></p>
<p>Continuing to focus on the previous area, we can also see that there is no strong need for <code>round</code> to be its own function. If we could just do the same job in <code>compress</code>, we could maybe use a for loop for the 7 rounds we have. And hopefully not having to jump to another function could help us.</p>
<p>To achieve that we first modify <code>g</code> to take the block directly and make it up to <code>g</code> to read from the array of block words:</p>
<div class="highlight highlight-source-typescript notranslate"><pre><span class="token keyword">function</span> <span class="token function">g</span><span class="token punctuation">(</span>state<span class="token operator">:</span> <span class="token">W16</span><span class="token punctuation">,</span> m<span class="token operator">:</span> <span class="token">W16</span><span class="token punctuation">,</span> x<span class="token operator">:</span> <span class="token">number</span><span class="token punctuation">,</span> y<span class="token operator">:</span> <span class="token">number</span><span class="token punctuation">,</span> a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token">PERMUTATIONS</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span>
    <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span>
    <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span>
    <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> mx <span class="token operator">=</span> m<span class="token punctuation">[</span><span class="token">PERMUTATIONS</span><span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> my <span class="token operator">=</span> m<span class="token punctuation">[</span><span class="token">PERMUTATIONS</span><span class="token punctuation">[</span>y<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></pre></div><p>Using this pattern allows us to modify compress's calls to round into:</p>
<div class="highlight highlight-source-typescript notranslate"><pre><span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">7</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// Mix the columns.</span>
  <span class="token function">g</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> block_words<span class="token punctuation">,</span> p<span class="token operator">++</span><span class="token punctuation">,</span> p<span class="token operator">++</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">g</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> block_words<span class="token punctuation">,</span> p<span class="token operator">++</span><span class="token punctuation">,</span> p<span class="token operator">++</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">g</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> block_words<span class="token punctuation">,</span> p<span class="token operator">++</span><span class="token punctuation">,</span> p<span class="token operator">++</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">g</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> block_words<span class="token punctuation">,</span> p<span class="token operator">++</span><span class="token punctuation">,</span> p<span class="token operator">++</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// Mix the diagonals.</span>
  <span class="token function">g</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> block_words<span class="token punctuation">,</span> p<span class="token operator">++</span><span class="token punctuation">,</span> p<span class="token operator">++</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">g</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> block_words<span class="token punctuation">,</span> p<span class="token operator">++</span><span class="token punctuation">,</span> p<span class="token operator">++</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">g</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> block_words<span class="token punctuation">,</span> p<span class="token operator">++</span><span class="token punctuation">,</span> p<span class="token operator">++</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">g</span><span class="token punctuation">(</span>state<span class="token punctuation">,</span> block_words<span class="token punctuation">,</span> p<span class="token operator">++</span><span class="token punctuation">,</span> p<span class="token operator">++</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre></div><p>This change removes one depth from a call to compress to the deepest function it calls, and surprisingly it is another <strong>1.24x improvement</strong> in the performance, making it a <strong>1.98x improvement</strong> including the previous step. Which means just by inlining the function a little and precomputing the permutations we have almost doubled the performance.</p>
<p><img src="/static/blake3/graph4.png" alt="Benchmark after Step 3" /></p>
<hr />
<h2 id="step-4-avoid-repeated-reads-and-writes-from-the-typedarray"><a class="anchor" aria-hidden="true" tabindex="-1" href="#step-4-avoid-repeated-reads-and-writes-from-the-typedarray"><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Step 4: Avoid Repeated Reads and Writes From the TypedArray</h2>
<p><strong>See this commit on GitHub:</strong> <a href="https://github.com/qti3e/blake3-js/commit/9ccff346c7d7e6d9562958fbec141b43fcbde401" rel="noopener noreferrer"><code>Use Variables Instead of an Array For State</code></a></p>
<p>A <code>Uint32Array</code> is fast, but constantly reading from it and writing to it might not be the best move, especially if we have a lot of writes. A call to <code>g</code> performs 8 writes and 18 reads. Compress has 7 rounds and each round has 8 calls to <code>g</code>, making up a total of <strong>448 writes and 1008 reads</strong> for each 64 bytes of the input. That's 7W, 16R per input byte on average (not considering the internal nodes in the tree). This is a lot of array access.</p>
<p>So what if state was not a <code>Uint32Array</code> and instead we could use 16 SMI variables? The challenge here is that <code>g</code> depends on dynamic access to the state, so we would have to hardcode and inline every call to <code>g</code> in order to pull this off.</p>
<p>This is another case where meta-programming makes the code easier to generate:</p>
<div class="highlight highlight-source-javascript notranslate"><pre><span class="token keyword">const</span> w <span class="token operator">=</span> console<span class="token punctuation">.</span>log<span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">right_rot</span><span class="token punctuation">(</span><span class="token">x<span class="token punctuation">,</span> y<span class="token punctuation">,</span> r</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">w</span><span class="token punctuation">(</span><span class="token"><span class="token string">`</span><span class="token string">    s_</span><span class="token"><span class="token punctuation">${</span>x<span class="token punctuation">}</span></span><span class="token string"> ^= s_</span><span class="token"><span class="token punctuation">${</span>y<span class="token punctuation">}</span></span><span class="token string">;</span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">w</span><span class="token punctuation">(</span><span class="token"><span class="token string">`</span><span class="token string">    s_</span><span class="token"><span class="token punctuation">${</span>x<span class="token punctuation">}</span></span><span class="token string"> = (s_</span><span class="token"><span class="token punctuation">${</span>x<span class="token punctuation">}</span></span><span class="token string"> &gt;&gt;&gt; </span><span class="token"><span class="token punctuation">${</span>r<span class="token punctuation">}</span></span><span class="token string">) | (s_</span><span class="token"><span class="token punctuation">${</span>x<span class="token punctuation">}</span></span><span class="token string"> &lt;&lt; </span><span class="token"><span class="token punctuation">${</span><span class="token number">32</span> <span class="token operator">-</span> r<span class="token punctuation">}</span></span><span class="token string">);</span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">g_inner</span><span class="token punctuation">(</span><span class="token">a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> d_rot<span class="token punctuation">,</span> b_rot</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">w</span><span class="token punctuation">(</span><span class="token"><span class="token string">`</span><span class="token string">    s_</span><span class="token"><span class="token punctuation">${</span>a<span class="token punctuation">}</span></span><span class="token string"> = (((s_</span><span class="token"><span class="token punctuation">${</span>a<span class="token punctuation">}</span></span><span class="token string"> + s_</span><span class="token"><span class="token punctuation">${</span>b<span class="token punctuation">}</span></span><span class="token string">) | 0) + m[PERMUTATIONS[p++]]) | 0;</span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">right_rot</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> a<span class="token punctuation">,</span> d_rot<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">w</span><span class="token punctuation">(</span><span class="token"><span class="token string">`</span><span class="token string">    s_</span><span class="token"><span class="token punctuation">${</span>c<span class="token punctuation">}</span></span><span class="token string"> = (s_</span><span class="token"><span class="token punctuation">${</span>c<span class="token punctuation">}</span></span><span class="token string"> + s_</span><span class="token"><span class="token punctuation">${</span>d<span class="token punctuation">}</span></span><span class="token string">) | 0;</span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">right_rot</span><span class="token punctuation">(</span>b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> b_rot<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">g</span><span class="token punctuation">(</span><span class="token">a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">g_inner</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">g_inner</span><span class="token punctuation">(</span>a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">w</span><span class="token punctuation">(</span><span class="token"><span class="token string">`</span><span class="token string">let s_</span><span class="token"><span class="token punctuation">${</span>i<span class="token punctuation">}</span></span><span class="token string"> = cv[</span><span class="token"><span class="token punctuation">${</span>i<span class="token punctuation">}</span></span><span class="token string">] | 0;</span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">w</span><span class="token punctuation">(</span><span class="token"><span class="token string">`</span><span class="token string">let s_8 = 0x6A09E667;</span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">w</span><span class="token punctuation">(</span><span class="token"><span class="token string">`</span><span class="token string">let s_9 = 0xBB67AE85;</span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">w</span><span class="token punctuation">(</span><span class="token"><span class="token string">`</span><span class="token string">let s_10 = 0x3C6EF372;</span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">w</span><span class="token punctuation">(</span><span class="token"><span class="token string">`</span><span class="token string">let s_11 = 0xA54FF53A;</span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">w</span><span class="token punctuation">(</span><span class="token"><span class="token string">`</span><span class="token string">let s_12 = counter | 0;</span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">w</span><span class="token punctuation">(</span><span class="token"><span class="token string">`</span><span class="token string">let s_13 = (counter / 0x100000000) | 0;</span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">w</span><span class="token punctuation">(</span><span class="token"><span class="token string">`</span><span class="token string">let s_14 = blockLen | 0;</span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">w</span><span class="token punctuation">(</span><span class="token"><span class="token string">`</span><span class="token string">let s_15 = flags | 0;</span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">w</span><span class="token punctuation">(</span><span class="token"><span class="token string">`</span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">w</span><span class="token punctuation">(</span><span class="token"><span class="token string">`</span><span class="token string">for (let i = 0; i &lt; 7; ++i) {</span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Mix the columns.</span>
<span class="token function">g</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">g</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">g</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">g</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Mix the diagonals.</span>
<span class="token function">g</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">15</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">g</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token number">11</span><span class="token punctuation">,</span> <span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">g</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">g</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">w</span><span class="token punctuation">(</span><span class="token"><span class="token string">`</span><span class="token string">}</span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">w</span><span class="token punctuation">(</span><span class="token"><span class="token string">`</span><span class="token string">return new Uint32Array([</span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">w</span><span class="token punctuation">(</span><span class="token"><span class="token string">`</span><span class="token string">    s_</span><span class="token"><span class="token punctuation">${</span>i<span class="token punctuation">}</span></span><span class="token string"> ^ s_</span><span class="token"><span class="token punctuation">${</span>i <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">}</span></span><span class="token string">,</span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">w</span><span class="token punctuation">(</span><span class="token"><span class="token string">`</span><span class="token string">    s_</span><span class="token"><span class="token punctuation">${</span>i <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">}</span></span><span class="token string"> ^ cv[</span><span class="token"><span class="token punctuation">${</span>i<span class="token punctuation">}</span></span><span class="token string">],</span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">w</span><span class="token punctuation">(</span><span class="token"><span class="token string">`</span><span class="token string">]);</span><span class="token string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div><p>Something about meta-programming that has always fascinated me is how the generator code does not always have to be beautiful or future-proof. It just needs to do its job in the stupidest but simplest possible way.</p>
<p>Running the code above generates a monstrosity (you can check it out on the GitHub repository), but here's the general idea:</p>
<div class="highlight highlight-source-typescript notranslate"><pre><span class="token keyword">let</span> s_0 <span class="token operator">=</span> cv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
<span class="token keyword">let</span> s_7 <span class="token operator">=</span> cv<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> s_8 <span class="token operator">=</span> <span class="token number">0x6a09e667</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> s_9 <span class="token operator">=</span> <span class="token number">0xbb67ae85</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> s_10 <span class="token operator">=</span> <span class="token number">0x3c6ef372</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> s_11 <span class="token operator">=</span> <span class="token number">0xa54ff53a</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> s_12 <span class="token operator">=</span> counter <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> s_13 <span class="token operator">=</span> <span class="token punctuation">(</span>counter <span class="token operator">/</span> <span class="token number">0x100000000</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> s_14 <span class="token operator">=</span> blockLen <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> s_15 <span class="token operator">=</span> flags <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">7</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  s_0 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>s_0 <span class="token operator">+</span> s_4<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> m<span class="token punctuation">[</span><span class="token">PERMUTATIONS</span><span class="token punctuation">[</span>p<span class="token operator">++</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">;</span>
  s_12 <span class="token operator">^=</span> s_0<span class="token punctuation">;</span>
  s_12 <span class="token operator">=</span> <span class="token punctuation">(</span>s_12 <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">16</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>s_12 <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  s_8 <span class="token operator">=</span> <span class="token punctuation">(</span>s_8 <span class="token operator">+</span> s_12<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">;</span>
  s_4 <span class="token operator">^=</span> s_8<span class="token punctuation">;</span>
  s_4 <span class="token operator">=</span> <span class="token punctuation">(</span>s_4 <span class="token operator">&gt;&gt;&gt;</span> <span class="token number">12</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>s_4 <span class="token operator">&lt;&lt;</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ... 90 more lines of these</span>
<span class="token punctuation">}</span>

<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  s_0 <span class="token operator">^</span> s_8<span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
  s_7 <span class="token operator">^</span> s_15<span class="token punctuation">,</span>
  s_8 <span class="token operator">^</span> cv<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
  s_15 <span class="token operator">^</span> cv<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token">W16</span><span class="token punctuation">;</span></pre></div><p>And that's how we get another <strong>2.2x performance boost</strong>. We're now almost in the same order of magnitude as the WASM implementation.</p>
<p><img src="/static/blake3/graph5.png" alt="Benchmark after Step 4" /></p>
<hr />
<h2 id="step-5-avoid-copies"><a class="anchor" aria-hidden="true" tabindex="-1" href="#step-5-avoid-copies"><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Step 5: Avoid Copies</h2>
<p><strong>See this commit on GitHub:</strong> <a href="https://github.com/qti3e/blake3-js/commit/a65f32d6e0c521a5a8c8367517196ab076ff87b3" rel="noopener noreferrer"><code>Avoid Copies</code></a></p>
<p>We have already seen the impact not copying data around into temporary places can have on performance. So in this step, our goal is simple: instead of giving data to compress and getting data back, what if we could use pointers and have an in-place implementation of compress?</p>
<p>Of course, there are no pointers in JavaScript, but not having to construct new instances of <code>UintNArray</code> is good enough for us. We could always pass an offset along a <code>Uint32Array</code> as a number to determine the starting range. Since compress already knows the size of all of the inputs it has to take, we would not need a closing range.</p>
<p>With that being said, here is the new signature for compress:</p>
<div class="highlight highlight-source-typescript notranslate"><pre><span class="token keyword">function</span> <span class="token function">compress</span><span class="token punctuation">(</span>
  cv<span class="token operator">:</span> Uint32Array<span class="token punctuation">,</span>
  cvOffset<span class="token operator">:</span> <span class="token">number</span><span class="token punctuation">,</span>
  blockWords<span class="token operator">:</span> Uint32Array<span class="token punctuation">,</span>
  blockWordsOffset<span class="token operator">:</span> <span class="token">number</span><span class="token punctuation">,</span>
  out<span class="token operator">:</span> Uint32Array<span class="token punctuation">,</span>
  outOffset<span class="token operator">:</span> <span class="token">number</span><span class="token punctuation">,</span>
  truncateOutput<span class="token operator">:</span> <span class="token">boolean</span><span class="token punctuation">,</span>
  counter<span class="token operator">:</span> <span class="token">number</span><span class="token punctuation">,</span>
  blockLen<span class="token operator">:</span> Word<span class="token punctuation">,</span>
  flags<span class="token operator">:</span> Word<span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></pre></div><p>If you pay attention closely you can see that along with the new out buffer, we also have added a new boolean flag called <code>truncateOutput</code>. This comes from the observation that in our current use case of the compress function we only ever need 8 words of the output. However, compress is capable of generating 16 words of output that are used in the XMD mode of the hash function (when we want larger than the default 256-bit output). The current hash function does not provide this functionality but we can still keep the possibility and future-proof the function.</p>
<p>The main part here is that now instead of returning a <code>W8</code> (which used to be a <code>new Uint32Array</code> every time), we can simply ask the caller where the output has to be written to.</p>
<p>Another huge part of this change is around not using an array for the <code>cvStack</code> since we can benefit from having two items in the stack right next to each other in the same <code>Uint32Array</code>.</p>
<p>Using a <code>Uint32Array</code> for the stack:</p>
<div class="highlight highlight-source-typescript notranslate"><pre><span class="token comment">// Old</span>
<span class="token keyword">const</span> cvStack<span class="token operator">:</span> <span class="token">W8</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// New</span>
<span class="token keyword">const</span> cvStack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span>maxCvDepth <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> cvStackPos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></div><p>Now with this new approach, pushing to the stack is as simple as writing the 8-word item to <code>cvStack[cvStackPos..]</code> followed by <code>cvStackPos += 8</code>, and to pop data from this stack we can just decrement <code>cvStackPos -= 8</code> and not care about overwriting the previous item.</p>
<p>Using the new stack we can rewrite the merge code in the following copy-free way:</p>
<div class="highlight highlight-source-typescript notranslate"><pre><span class="token keyword">let</span> totalChunks <span class="token operator">=</span> chunkCounter<span class="token punctuation">;</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>totalChunks <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  cvStackPos <span class="token operator">-=</span> <span class="token number">16</span><span class="token punctuation">;</span> <span class="token comment">// pop 2 items</span>
  <span class="token function">compress</span><span class="token punctuation">(</span>
    keyWords<span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span>
    cvStack<span class="token punctuation">,</span>     <span class="token comment">// -&gt; blockWords</span>
    cvStackPos<span class="token punctuation">,</span>  <span class="token comment">// -&gt; blockWordsOffset</span>
    cvStack<span class="token punctuation">,</span>     <span class="token comment">// -&gt; out</span>
    cvStackPos<span class="token punctuation">,</span>  <span class="token comment">// -&gt; outOffset</span>
    <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token">BLOCK_LEN</span><span class="token punctuation">,</span>
    flags <span class="token operator">|</span> <span class="token">PARENT</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  cvStackPos <span class="token operator">+=</span> <span class="token number">8</span><span class="token punctuation">;</span> <span class="token comment">// push 1 item! (the out)</span>
  totalChunks <span class="token operator">&gt;&gt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre></div><p>This change gave us a <strong>3x performance improvement</strong> and now we are around 3/4th of the speed of WebAssembly! Remember how we started from being ~2000x slower?</p>
<p><img src="/static/blake3/graph6.png" alt="Benchmark after Step 5" /></p>
<hr />
<h2 id="step-6-using-variables-for-blockwords"><a class="anchor" aria-hidden="true" tabindex="-1" href="#step-6-using-variables-for-blockwords"><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Step 6: Using Variables for blockWords</h2>
<p><strong>See this commit on GitHub:</strong> <a href="https://github.com/qti3e/blake3-js/commit/7a0d2d0db807c76e129a8c6b27bf5dc74f934c9a" rel="noopener noreferrer"><code>Use Local Variables to Access blockWords in Compress</code></a></p>
<p>Similar to step 4, our goal here is to do the same thing we did with state but this time with blockWords.</p>
<p>This means that we have to give up on the <code>PERMUTATIONS</code> table and do the permutations by actually swapping the variables because we cannot have dynamic access to variables.</p>
<p>First, we need to load the proper bytes into the variables:</p>
<div class="highlight highlight-source-typescript notranslate"><pre><span class="token keyword">let</span> m_0 <span class="token operator">=</span> blockWords<span class="token punctuation">[</span>blockWordsOffset <span class="token operator">+</span> <span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">// ...</span>
<span class="token keyword">let</span> m_15 <span class="token operator">=</span> blockWords<span class="token punctuation">[</span>blockWordsOffset <span class="token operator">+</span> <span class="token number">15</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></div><p>For the permutation, we can analyze the permutation pattern and optimize the swaps:</p>
<div class="highlight highlight-source-typescript notranslate"><pre><span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">!=</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> t0 <span class="token operator">=</span> m_0<span class="token punctuation">;</span>
  <span class="token keyword">const</span> t1 <span class="token operator">=</span> m_1<span class="token punctuation">;</span>
  m_0 <span class="token operator">=</span> m_2<span class="token punctuation">;</span>
  m_2 <span class="token operator">=</span> m_3<span class="token punctuation">;</span>
  m_3 <span class="token operator">=</span> m_10<span class="token punctuation">;</span>
  m_10 <span class="token operator">=</span> m_12<span class="token punctuation">;</span>
  m_12 <span class="token operator">=</span> m_9<span class="token punctuation">;</span>
  m_9 <span class="token operator">=</span> m_11<span class="token punctuation">;</span>
  m_11 <span class="token operator">=</span> m_5<span class="token punctuation">;</span>
  m_5 <span class="token operator">=</span> t0<span class="token punctuation">;</span>
  m_1 <span class="token operator">=</span> m_6<span class="token punctuation">;</span>
  m_6 <span class="token operator">=</span> m_4<span class="token punctuation">;</span>
  m_4 <span class="token operator">=</span> m_7<span class="token punctuation">;</span>
  m_7 <span class="token operator">=</span> m_13<span class="token punctuation">;</span>
  m_13 <span class="token operator">=</span> m_14<span class="token punctuation">;</span>
  m_14 <span class="token operator">=</span> m_15<span class="token punctuation">;</span>
  m_15 <span class="token operator">=</span> m_8<span class="token punctuation">;</span>
  m_8 <span class="token operator">=</span> t1<span class="token punctuation">;</span>
<span class="token punctuation">}</span></pre></div><p>Running this new version of the code shows another <strong>1.5x improvement</strong>, reaching performance higher than WebAssembly for the first time so far. But just being a little faster is not a reason to stop.</p>
<p><img src="/static/blake3/graph7.png" alt="Benchmark after Step 6" /></p>
<hr />
<h2 id="step-7-reuse-internal-buffers"><a class="anchor" aria-hidden="true" tabindex="-1" href="#step-7-reuse-internal-buffers"><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Step 7: Reuse Internal Buffers</h2>
<p><strong>See this commit on GitHub:</strong> <a href="https://github.com/qti3e/blake3-js/commit/568d62dc99a0e04cbd0341befd492868429f3d49" rel="noopener noreferrer"><code>Reuse Global Uint8Array</code></a></p>
<p>This is a simple change. The idea is that once we create a <code>Uint32Array</code> either for blockWords or for cvStack, we should keep them around and reuse them as long as they are big enough:</p>
<div class="highlight highlight-source-typescript notranslate"><pre><span class="token comment">// Pre-allocate and reuse when possible.</span>
<span class="token keyword">const</span> blockWords <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token">W16</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> cvStack<span class="token operator">:</span> Uint32Array <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">getCvStack</span><span class="token punctuation">(</span>maxDepth<span class="token operator">:</span> <span class="token">number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> depth <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>maxDepth<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> length <span class="token operator">=</span> depth <span class="token operator">*</span> <span class="token number">8</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cvStack <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> cvStack<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cvStack <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> cvStack<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">hash</span><span class="token punctuation">(</span>input<span class="token operator">:</span> Uint8Array<span class="token punctuation">)</span><span class="token operator">:</span> Uint8Array <span class="token punctuation">{</span>
  <span class="token keyword">const</span> flags <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> keyWords <span class="token operator">=</span> <span class="token">IV</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> out <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// The hasher state.</span>
  <span class="token keyword">const</span> maxCvDepth <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">log2</span><span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">+</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span>length <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> cvStack <span class="token operator">=</span> <span class="token function">getCvStack</span><span class="token punctuation">(</span>maxCvDepth<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></pre></div><p>The performance change here is not that much visibleâ€”it's only <strong>1.023x</strong> which means going from 425MB/s to 435MB/s.</p>
<hr />
<h2 id="step-8-blake3-is-little-endian-friendly"><a class="anchor" aria-hidden="true" tabindex="-1" href="#step-8-blake3-is-little-endian-friendly"><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Step 8: Blake3 Is Little Endian Friendly</h2>
<p><strong>See this commit on GitHub:</strong> <a href="https://github.com/qti3e/blake3-js/commit/c6bb4c3becf0c8acd54ea81331af8aa468a527e7" rel="noopener noreferrer"><code>Optimize for Little Endian Systems</code></a></p>
<p>Blake3 is really Little Endian friendly and since most user-facing systems are indeed Little Endian, this is really good news and we can take advantage of it.</p>
<p>Right now even if we are running on a Little Endian machine, we still call <code>readLittleEndianFull</code> in order to read the input data into blockWords first before calling compress. However, if we're already on a Little Endian machine, that read is useless and we could allow compress to read directly from the input buffer without any intermediary temporary relocation.</p>
<div class="highlight highlight-source-typescript notranslate"><pre><span class="token keyword">const</span> IsBigEndian <span class="token operator">=</span> <span class="token operator">!</span><span class="token keyword">new</span> <span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>buffer<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// ...</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">hash</span><span class="token punctuation">(</span>input<span class="token operator">:</span> Uint8Array<span class="token punctuation">)</span><span class="token operator">:</span> Uint8Array <span class="token punctuation">{</span>
  <span class="token keyword">const</span> inputWords <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uint32Array</span><span class="token punctuation">(</span>
    input<span class="token punctuation">.</span>buffer<span class="token punctuation">,</span>
    input<span class="token punctuation">.</span>byteOffset<span class="token punctuation">,</span>
    input<span class="token punctuation">.</span>byteLength <span class="token operator">&gt;&gt;</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// ...</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">,</span> offset <span class="token operator">+=</span> <span class="token number">64</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>IsBigEndian<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">readLittleEndianWordsFull</span><span class="token punctuation">(</span>input<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> blockWords<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token function">compress</span><span class="token punctuation">(</span>
      cvStack<span class="token punctuation">,</span>
      cvStackPos<span class="token punctuation">,</span>
      IsBigEndian <span class="token operator">?</span> blockWords <span class="token operator">:</span> inputWords<span class="token punctuation">,</span>
      IsBigEndian <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> offset <span class="token operator">/</span> <span class="token number">4</span><span class="token punctuation">,</span>
      cvStack<span class="token punctuation">,</span>
      cvStackPos<span class="token punctuation">,</span>
      <span class="token boolean">true</span><span class="token punctuation">,</span>
      chunkCounter<span class="token punctuation">,</span>
      <span class="token">BLOCK_LEN</span><span class="token punctuation">,</span>
      flags <span class="token operator">|</span> <span class="token punctuation">(</span>i <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token">CHUNK_START</span> <span class="token operator">:</span> i <span class="token operator">===</span> <span class="token number">15</span> <span class="token operator">?</span> <span class="token">CHUNK_END</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span></pre></div><p>With this change, we get yet again another <strong>1.48x performance improvement</strong>! And now things look even better for JavaScript than WASM by some reasonable margin. Now we are <strong>1.6 times faster</strong> than WebAssembly in pure JavaScript.</p>
<p><img src="/static/blake3/graph8.png" alt="Benchmark after Step 8" /></p>
<hr />
<h2 id="giving-wasm-simd-a-chance"><a class="anchor" aria-hidden="true" tabindex="-1" href="#giving-wasm-simd-a-chance"><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Giving WASM SIMD a Chance</h2>
<p>Earlier in this blog I promised that we will not be shipping a WASM file. Of course in theory you can just encode the file in base64 and include it as text in JS. But who on earth would find that ok?</p>
<p>Since we already explored meta-programming and saw how small the generator code is, we can try to reuse the same ideas to generate the WASM file on load. This is of course something that is going to require us to understand the WASM binary format at a good enough level to write a WASM file by hand.</p>
<h3 id="wasm-binary-format"><a class="anchor" aria-hidden="true" tabindex="-1" href="#wasm-binary-format"><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>WASM Binary Format</h3>
<p>A WASM module consists of a header and then a few (optional) sections. The header is only the magic bytes and the version of the module. These are hardcoded values. Then we have the following sections that we care about:</p>
<ol>
<li><strong>SECTION 1: Types</strong> - Contains type definitions of the different functions in the module.</li>
<li><strong>SECTION 2: Imports</strong> - Where the WASM tells the host what needs to be imported (e.g., memory).</li>
<li><strong>SECTION 3: Functions</strong> - List of functions by their type alias.</li>
<li><strong>SECTION 7: Exports</strong> - Which functions are exported and their names.</li>
<li><strong>SECTION 10: Code</strong> - Function definitions including local variables and instructions.</li>
</ol>
<div class="highlight highlight-source-javascript notranslate"><pre><span class="token keyword">const</span> wasmCode <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x61</span><span class="token punctuation">,</span> <span class="token number">0x73</span><span class="token punctuation">,</span> <span class="token number">0x6d</span><span class="token punctuation">,</span> <span class="token comment">// magic</span>
  <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token comment">// version</span>

  <span class="token comment">// SECTION 1: Types</span>
  <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token number">0x04</span><span class="token punctuation">,</span>
  <span class="token number">0x01</span><span class="token punctuation">,</span>
  <span class="token comment">// T0: func compress4x() -&gt; ()</span>
  <span class="token number">0x60</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span>

  <span class="token comment">// SECTION 2: Imports</span>
  <span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token number">0x0b</span><span class="token punctuation">,</span>
  <span class="token number">0x01</span><span class="token punctuation">,</span>
  <span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token number">0x6a</span><span class="token punctuation">,</span> <span class="token number">0x73</span><span class="token punctuation">,</span> <span class="token comment">// mod="js"</span>
  <span class="token number">0x03</span><span class="token punctuation">,</span> <span class="token number">0x6d</span><span class="token punctuation">,</span> <span class="token number">0x65</span><span class="token punctuation">,</span> <span class="token number">0x6d</span><span class="token punctuation">,</span> <span class="token comment">// nm="mem"</span>
  <span class="token number">0x02</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x01</span><span class="token punctuation">,</span> <span class="token comment">// mem {min=1, max=empty}</span>

  <span class="token comment">// SECTION 3: Functions</span>
  <span class="token number">0x03</span><span class="token punctuation">,</span> <span class="token number">0x02</span><span class="token punctuation">,</span>
  <span class="token number">0x01</span><span class="token punctuation">,</span>
  <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token comment">// T0</span>

  <span class="token comment">// SECTION 7: Exports</span>
  <span class="token number">0x07</span><span class="token punctuation">,</span> <span class="token number">0x0e</span><span class="token punctuation">,</span>
  <span class="token number">0x01</span><span class="token punctuation">,</span>
  <span class="token comment">// name="compress4x"</span>
  <span class="token number">0x0a</span><span class="token punctuation">,</span> <span class="token number">0x63</span><span class="token punctuation">,</span> <span class="token number">0x6F</span><span class="token punctuation">,</span> <span class="token number">0x6D</span><span class="token punctuation">,</span> <span class="token number">0x70</span><span class="token punctuation">,</span> <span class="token number">0x72</span><span class="token punctuation">,</span> <span class="token number">0x65</span><span class="token punctuation">,</span> <span class="token number">0x73</span><span class="token punctuation">,</span> <span class="token number">0x73</span><span class="token punctuation">,</span> <span class="token number">0x34</span><span class="token punctuation">,</span> <span class="token number">0x78</span><span class="token punctuation">,</span>
  <span class="token comment">// export desc: funcidx</span>
  <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span>

  <span class="token comment">// SECTION 10: Code</span>
  <span class="token number">0x0a</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span>
  <span class="token number">0x01</span><span class="token punctuation">,</span>
  <span class="token comment">// size:u32; to be filled later</span>
  <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span>
  <span class="token comment">// begin func:</span>
  <span class="token number">0x01</span><span class="token punctuation">,</span>
  <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token number">0x7b</span><span class="token punctuation">,</span> <span class="token comment">// 32xv128</span>

  <span class="token comment">// -- Instructions go here.</span>

  <span class="token number">0x0b</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">;</span></pre></div><h3 id="what-is-simd"><a class="anchor" aria-hidden="true" tabindex="-1" href="#what-is-simd"><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>What is SIMD?</h3>
<p>SIMD stands for <strong>Single Instruction Multiple Data</strong>. It's basically a vectorized type. WASM supports <code>v128</code> which means a vector consisting of 128-bits. Instructions can view this data in different waysâ€”for example, <code>i32x4</code> means 4 i32 values, or <code>i8x16</code> for 16 bytes. Notice how the total size stays the same: 128=32Ã—4=8Ã—16.</p>
<h3 id="memory-layout"><a class="anchor" aria-hidden="true" tabindex="-1" href="#memory-layout"><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Memory Layout</h3>
<p>A simple call to our normal compress function works with 16 words of state if it reuses the state as the output. For <code>compress4x</code>, we need 4 times as much data, rearranged into vectors where each <code>s[i]</code> contains the values from all 4 inputs.</p>
<h3 id="some-webassembly-instructions"><a class="anchor" aria-hidden="true" tabindex="-1" href="#some-webassembly-instructions"><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Some WebAssembly Instructions</h3>
<p>WebAssembly is a stack-based virtual machine. Here are the key instructions we use:</p>
<table>
<thead>
<tr>
<th>Name</th>
<th>Binary Format</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>local.get</code></td>
<td><code>0x20, N</code></td>
<td>Push <code>$N</code> to stack</td>
</tr>
<tr>
<td><code>local.set</code></td>
<td><code>0x21, N</code></td>
<td>Pop into <code>$N</code></td>
</tr>
<tr>
<td><code>local.tee</code></td>
<td><code>0x22, N</code></td>
<td>Copy top to <code>$N</code> (no pop)</td>
</tr>
<tr>
<td><code>i32.const</code></td>
<td><code>0x41, ...LEB</code></td>
<td>Push constant</td>
</tr>
<tr>
<td><code>v128.load</code></td>
<td><code>0xfd, 0, ALIGN, OFFSET</code></td>
<td>Load <code>v128</code> from address</td>
</tr>
<tr>
<td><code>v128.store</code></td>
<td><code>0xfd, 11, ALIGN, OFFSET</code></td>
<td>Store <code>v128</code> to address</td>
</tr>
<tr>
<td><code>v128.or</code></td>
<td><code>0xfd, 80</code></td>
<td>Bitwise OR two <code>v128</code></td>
</tr>
<tr>
<td><code>v128.xor</code></td>
<td><code>0xfd, 81</code></td>
<td>Bitwise XOR two <code>v128</code></td>
</tr>
<tr>
<td><code>i32x4.shl</code></td>
<td><code>0xfd, 171, 1</code></td>
<td>Left shift <code>i32x4</code> by <code>i32</code></td>
</tr>
<tr>
<td><code>i32x4.shr_u</code></td>
<td><code>0xfd, 173, 1</code></td>
<td>Unsigned right shift <code>i32x4</code> by <code>i32</code></td>
</tr>
<tr>
<td><code>i32x4.add</code></td>
<td><code>0xfd, 174, 1</code></td>
<td>Add two <code>i32x4</code></td>
</tr>
</tbody></table>
<p>Using only these 11 instructions we can implement the <code>compress4x</code> function.</p>
<h3 id="generating-the-code"><a class="anchor" aria-hidden="true" tabindex="-1" href="#generating-the-code"><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Generating the Code</h3>
<p>Since we placed blockWords in <code>$0..$15</code>, we can simply use the same permutation tables as variable indices. Anywhere we had <code>state[i]</code> we access <code>$[16 + i]</code>:</p>
<div class="highlight highlight-source-javascript notranslate"><pre><span class="token comment">// Mix the columns.</span>
<span class="token function">g</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">g</span><span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">g</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">26</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">g</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">27</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Mix the diagonals.</span>
<span class="token function">g</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">,</span> <span class="token number">21</span><span class="token punctuation">,</span> <span class="token number">26</span><span class="token punctuation">,</span> <span class="token number">31</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">g</span><span class="token punctuation">(</span><span class="token number">17</span><span class="token punctuation">,</span> <span class="token number">22</span><span class="token punctuation">,</span> <span class="token number">27</span><span class="token punctuation">,</span> <span class="token number">28</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">g</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">23</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">,</span> <span class="token number">29</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">g</span><span class="token punctuation">(</span><span class="token number">19</span><span class="token punctuation">,</span> <span class="token number">20</span><span class="token punctuation">,</span> <span class="token number">25</span><span class="token punctuation">,</span> <span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></div><hr />
<h2 id="step-9-simple-use-of-compress4x"><a class="anchor" aria-hidden="true" tabindex="-1" href="#step-9-simple-use-of-compress4x"><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Step 9: Simple use of compress4x</h2>
<p><strong>See this commit on GitHub:</strong> <a href="https://github.com/qti3e/blake3-js/commit/main" rel="noopener noreferrer"><code>Use WASM SIMD</code></a></p>
<p>We take as many 4KB chunks of data as we can (except for the last block) and pass them to <code>compress4x</code>. Since WASM is always little-endian, we make sure the bytes are also little-endian before writing them to the WASM memory.</p>
<p>We can see a <strong>1.39x improvement</strong> from the last benchmark. At this point, we're <strong>2.21x faster</strong> than the WebAssembly implementation we started with. And the good news is our WASM never asks for more memory pagesâ€”it only ever needs 1 page regardless of the input size. Which in itself is a huge win for us.</p>
<p><img src="/static/blake3/graph9.png" alt="Benchmark after Step 9" /></p>
<hr />
<h2 id="future-work"><a class="anchor" aria-hidden="true" tabindex="-1" href="#future-work"><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M7.775 3.275a.75.75 0 001.06 1.06l1.25-1.25a2 2 0 112.83 2.83l-2.5 2.5a2 2 0 01-2.83 0 .75.75 0 00-1.06 1.06 3.5 3.5 0 004.95 0l2.5-2.5a3.5 3.5 0 00-4.95-4.95l-1.25 1.25zm-4.69 9.64a2 2 0 010-2.83l2.5-2.5a2 2 0 012.83 0 .75.75 0 001.06-1.06 3.5 3.5 0 00-4.95 0l-2.5 2.5a3.5 3.5 0 004.95 4.95l1.25-1.25a.75.75 0 00-1.06-1.06l-1.25 1.25a2 2 0 01-2.83 0z"></path></svg></a>Future Work</h2>
<p>Blake3 is an awesome hash functionâ€”one that has unlimited potential for parallelization and optimizations. In this blog we focused on the performance of V8, so expect a detailed benchmark on different browsers and engines at some point.</p>
<p>Another path that was explored but did not make it to the blog is <strong>asm.js</strong>. All I have to say about asm.js is that V8 is already so good at static analysis that asm.js did not make much of a difference. However, it did improve the performance of the pure JS compress function on Firefox when I tested it a few months back.</p>
<p>And of course, an important task is packaging all of this in a nice and easy-to-use module. So stay tuned for the release! In the meantime, if you're using Deno, you know how to import a file from GitHub. So don't be shy and go ahead and star this blog's repo.</p>

      </main>
      <footer class="footer">
        <p class="clip-copy">curl "https://parsa.wtf/blake3.md" | less</p>
        
      </footer>
      </div>
    </div>
  </body>
</html>